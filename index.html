<!DOCTYPE html>
<html>
<head>
  <title>IFHub</title>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" type="image/png" href="./resources/ifhubicon.png">
  <link rel="apple-touch-icon" sizes="128x128" href="./resources/ifhubicon.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
  <script src="./resources/airportlocationdata.js"></script>
  <script src="./resources/liverydata.js"></script>
  <style>
    body {
        font-family: Arial, Helvetica, sans-serif;
    }
    html {
      box-sizing: border-box;
    }


    hr{
        height: 2px;
        background-color: #Fbdd05;
        border: none;
    }

    *, *:before, *:after {
      box-sizing: inherit;
    }

    .sidenav {
        height: auto;
        width: 30%;
        background-color: grey;
        position: fixed;
        border-radius: 5px;
        z-index:2;
        top: 10;
        left: 69%;
        display: none;
        transition: 0.3s;
        overflow-y: auto;
        min-height: 85%;
    }

    @media (max-width: 480px) {
      .sidenav{
        height: auto;
        width: 100%;
        background-color: grey;
        position: fixed;
        border-radius: 5px;
        z-index:2;
        left: 0%;
        bottom: 0;
        display: none;
        transition: 0.3s;
        overflow-y: auto;
        min-height: 50%;
      }
    }


    .sidenav a {
        padding: 8px 8px 8px 32px;
        text-decoration: none;
        font-size: 15px;
        color: #FFFFFF;
        transition: 0.3s;
    }

    .sidenav a:hover {
        color: #f1f1f1;
    }



    #rcorners1 {
      text-align: center;
      box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
      background-color: black;
      font-family: Arial, Helvetica, sans-serif;
    }

    #rcorners2 {
      text-align: center;
      box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
      background-color: white;
      font-family: Arial, Helvetica, sans-serif;
    }

    #rcorners3 {
      text-align: center;
      padding-top: 10px;
      padding-bottom: 10px;
      box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
      background-color: white;
      font-family: Arial, Helvetica, sans-serif;
    }

    #rcorners4 {
      box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
      background-color: #2a2a2a;
      color: #Fbdd05;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 15px;
    }

    .h3{
      letter-spacing: .25px
    }

    #MapContainer {
      transition: margin-left .5s;
      position: absolute;
      top: 0;
      z-index:1;
      right: 0;
      bottom: 0;
      left: 0;
    }

    @media screen and (max-height: 500px) {
      .sidenav {padding-top: 15px;}
      .sidenav a {font-size: 18px;}
    }

    .wrapper {
			width: 100%;
		}

    .progress-bar {
      width: 80%;
      margin: auto;
      background-color: #000000;
      padding: 1%;
      border-radius: 1%;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, .2);
    }

    .progress-bar-fill {
      display: block;
      height: 22px;
      background-color: #Fbdd05;
      border-radius: 6px;
      transition: width 2000ms ease-in-out;
    }

  </style>
</head>
<body>

<div id="mySidenav" class="sidenav">
  <h3 id="rcorners1">Just a Test!</h3>
  <h3 id="rcorners3">Awaiting onclick...</h3>
  <h3 id="rcorners2">Welcome to IFHUB!</h3>
  <canvas id='canvas' style='display: none;'></canvas>
  <h3 id="rcorners4">Oops!</h3>
</div>

<div id="MapContainer"></div>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
  <script type="text/javascript"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
  <link rel="stylesheet" href="./resources/ifhubsearch.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
  <script src='./resources/ifhubutils.js'></script>
  <script src='./resources/ifhubsearch.js'></script>
  <script>

      var UPDATING = 'no'
      var TYPE = ''

      function openNav() {
        ifclick = 'yes'
          document.getElementById('canvas').style.display = 'none'
          document.getElementById("mySidenav").style.height = "280px";
          document.getElementById("mySidenav").style.display = "block"

          //document.getElementById("MapContainer").style.marginTop = "280px";
      }

      function closeNav() {
        if (UPDATING == 'no'){
          ifclick = 'no'
        }
          document.getElementById('canvas').style.display = 'none'
          try{
            myLineChart.destroy();
          }
          catch(err){
            null;
          }
          map.closePopup();

          document.getElementById("mySidenav").style.height = "0";
          document.getElementById("mySidenav").style.display = "none"
          //document.getElementById("MapContainer").style.marginTop= "0";
      }

    function compare( a, b ) {
      if ( a.due < b.due ){
        return -1;
      }
      if ( a.due > b.due ){
        return 1;
      }
      return 0;
    }

      function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; // Radius of the earth in km
        var dLat = deg2rad(lat2-lat1);  // deg2rad below
        var dLon = deg2rad(lon2-lon1);
        var a =
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
          Math.sin(dLon/2) * Math.sin(dLon/2)
          ;
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        var d = R * c; // Distance in km
        return d;
      }

      function deg2rad(deg) {
        return deg * (Math.PI/180)
      }

      //And can we have a option which the user can change what is displayed on the pop up?

      (function() {
        // save these original methods before they are overwritten
        var proto_initIcon = L.Marker.prototype._initIcon;
        var proto_setPos = L.Marker.prototype._setPos;

        var oldIE = (L.DomUtil.TRANSFORM === 'msTransform');

        L.Marker.addInitHook(function () {
            var iconOptions = this.options.icon && this.options.icon.options;
            var iconAnchor = iconOptions && this.options.icon.options.iconAnchor;
            if (iconAnchor) {
                iconAnchor = (iconAnchor[0] + 'px ' + iconAnchor[1] + 'px');
            }
            this.options.rotationOrigin = this.options.rotationOrigin || iconAnchor || 'center bottom' ;
            this.options.rotationAngle = this.options.rotationAngle || 0;

            // Ensure marker keeps rotated during dragging
            this.on('drag', function(e) { e.target._applyRotation(); });
        });

        L.Marker.include({
            _initIcon: function() {
                proto_initIcon.call(this);
            },

            _setPos: function (pos) {
                proto_setPos.call(this, pos);
                this._applyRotation();
            },

            _applyRotation: function () {
                if(this.options.rotationAngle) {
                    this._icon.style[L.DomUtil.TRANSFORM+'Origin'] = this.options.rotationOrigin;

                    if(oldIE) {

                        this._icon.style[L.DomUtil.TRANSFORM] = 'rotate(' + this.options.rotationAngle + 'deg)';
                    } else {

                        this._icon.style[L.DomUtil.TRANSFORM] += ' rotateZ(' + this.options.rotationAngle + 'deg)';
                    }
                }
            },

            setRotationAngle: function(angle) {
                this.options.rotationAngle = angle;
                this.update();
                return this;
            },

            setRotationOrigin: function(origin) {
                this.options.rotationOrigin = origin;
                this.update();
                return this;
            }
        });
      })();

      var takeoff_dict = {}                     //Must be global
      var landing_dict = {}                     //Must be global
      var dict = {}
      var active_atc = {}
      var atc_dict = {}
      var flight_dict = {}
      var all_flights_start_end = {}
      var name_flightid = {}
      var plane_markers = {}
      var airport_markers = {}
      var CURRENT_FLIGHT_DATA = {}
      var latlngs_dict = {}
      var NEED_TO_UPDATE = 'no'
      var inboundFlightsDict = {}
      var outboundFlightsDict = {}
      var CURRENT_TRACK = ''
      var TO_UPDATE = 'no'

      var atc_frequency_convert = {0 :  "Ground",
                                   1 :  "Tower",
                                   2 :  "Unicom",
                                   3 :  "Clearance",
                                   4 :  "Approach",
                                   5 :  "Departure",
                                   6 :  "Center",
                                   7 :  "ATIS",
                                   8 :  "Aircraft",
                                   9 :  "Recorded",
                                   10:  "Unknown",
                                   11:  "Unused"}

      var flightline;
      var marker;
      var ifclick = "no"
      var serverurl = "df2a8d19-3a54-4ce5-ae65-0b722186e44c"
      var zoom = 3
      var lat = 0
      var line_colour = ""
      var long = 0
      var delayedForSearch = {}
      var check_lat = 0
      var check_long = 0
      var check_zoom = 3
      var strikes = 0
      var data = ""
      var xhr4 = ""

      var map = L.map('MapContainer').setView([0, 0], 3);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);       //Just for the sake of being abple to remove it

        L.easyButton( '<strong>E</strong>', function(){
          serverurl = "df2a8d19-3a54-4ce5-ae65-0b722186e44c"
          //airport_dict("7e5dcd44-1fb5-49cc-bc2c-a9aab1f6a856")
          flight("df2a8d19-3a54-4ce5-ae65-0b722186e44c")
          airport("df2a8d19-3a54-4ce5-ae65-0b722186e44c")
        }).addTo(map);

        L.easyButton( '<strong>T</strong>', function(){
          serverurl = "45173539-5080-4c95-9b93-a24713d96ec8"
          //airport_dict("6a04ffe8-765a-4925-af26-d88029eeadba")
          flight(serverurl)
          airport("45173539-5080-4c95-9b93-a24713d96ec8")
        }).addTo(map);

        L.easyButton( '<strong>C</strong>', function(){
          serverurl = "d01006e4-3114-473c-8f69-020b89d02884"
          //airport_dict("5f3fdc11-35b8-4268-832f-42f1c6539ab9")
          flight("d01006e4-3114-473c-8f69-020b89d02884")
          airport("d01006e4-3114-473c-8f69-020b89d02884")
        }).addTo(map);

        function redirectToPlane(data){
          location.href= 'https://ifhub.onrender.com/?flightid='+data+'&serverid='+serverurl
        }

      	function customTip(text,val) {
          fid = name_flightid[text]
          if (delayedForSearch[text] == 'On Time'){
            msg = delayedForSearch[text]
            colour = '#c1e1c1'
          }else if (delayedForSearch[text] == 'Delayed'){
            msg = delayedForSearch[text]
            colour = '#ff6961'
          }else{
            msg = 'Unavailable'
            colour = '#5A5A5A'
          }
      		return '<a onclick="redirectToPlane(\'' + fid + '\')" />'+text+"&nbsp &nbsp <b style='background:"+colour+"; color: white;'>" + msg + '</b><em style="background:'+text+'; width:18px;height:14px;float:right"></em></a>';
      	}

      var markerGroup = L.layerGroup().addTo(map);
      var atcGroup = L.layerGroup().addTo(map);
      var nonAtcGroup = L.layerGroup().addTo(map);
      var flightpath = L.layerGroup().addTo(map);
      var controlSearch = new L.Control.Search({
                        		layer: markerGroup,
                        		initial: true,
                        		marker: false,
                            buildTip:customTip
                        	});
	    map.addControl(controlSearch);
      map.on('zoomend', function(){
        if (map.getZoom() < 7){
          map.removeLayer(nonAtcGroup)
        } else {
          map.addLayer(nonAtcGroup)
        }
      })

      var myLineChart;

      function airport(serverurl){
        var xhr = new XMLHttpRequest();
        xhr.open('GET', "https://ifhubapi.onrender.com/getAtcFacilities?apikey=ZNvNHJYC5IcLYUMlFpBI&sessionid=" + serverurl, true);
        xhr.send();
        xhr.addEventListener("readystatechange", processRequest, false);

        function processRequest(e) {
          if (xhr.readyState == 4 && xhr.status == 200) {
            response = JSON.parse(xhr.responseText)['result'];
            all_facilities = {}
            map.removeLayer(atcGroup)
            map.removeLayer(nonAtcGroup)
            atcGroup = L.layerGroup().addTo(map);
            nonAtcGroup = L.layerGroup().addTo(map);
            active_atc = {}
            airport_markers = {}
            date = new Date()

            // global for timeline
            inboundFlightsDict = {}
            outboundFlightsDict = {}
            var hasActiveATC = []
            for (i = 0; i < response.length; i++) {

              // loop through inbound and outbound and add to dict

              for (j=0; j < response[i]['inboundFlights'].length; j++){
                inboundFlightsDict[response[i]['inboundFlights'][j]] = response[i]['airportIcao']
              }
              for (j=0; j < response[i]['outboundFlights'].length; j++){
                outboundFlightsDict[response[i]['outboundFlights'][j]] = response[i]['airportIcao']
              }

              if (response[i]['atcFacilities'].length > 0){
                var icao = response[i]['airportIcao']
                hasActiveATC.push(icao)
                for (j = 0; j < response[i]['atcFacilities'].length; j++){
                  var lat = response[i]['atcFacilities'][j].latitude
                  var long = response[i]['atcFacilities'][j].longitude
                  var name = response[i]['atcFacilities'][j].airportName
                  var controller = response[i]['atcFacilities'][j].username
                  var type = response[i]['atcFacilities'][j].type
                  var atc_converted = atc_frequency_convert[type]
                  if (active_atc.hasOwnProperty(name) == false){
                    active_atc[name] = atc_converted + ' : ' + controller
                  } else{
                    active_atc[name] = active_atc[name] + '<br>' + atc_converted + ' : ' + controller
                  }
                }
              } else {
                try {
                  var icao = response[i]['airportIcao']
                  var lat = AIRPORT_LOCATION_DATA[icao]['coordinates'].split(',')[0]
                  var long = AIRPORT_LOCATION_DATA[icao]['coordinates'].split(',')[1]
                  var name = AIRPORT_LOCATION_DATA[icao]['name']
                  active_atc[name] = 'This airport has no active ATC.'
                } catch(err){
                  continue;
                }
              }
              var marker = L.marker([lat, long], {title:name}).on('click', L.bind(function(e){
                ifclick = "yes"
                CURRENT_TRACK = e.target.getPopup()._content
                inbound = response[atc_dict[e.target.getPopup()._content]['index']]['inboundFlights']
                outbound = response[atc_dict[e.target.getPopup()._content]['index']]['outboundFlights']
                inboundList = []
                outboundList = []
                if (response[atc_dict[e.target.getPopup()._content]['index']]['atcFacilities'].length > 0){
                  lat = response[atc_dict[e.target.getPopup()._content]['index']]['atcFacilities'][0]['latitude']
                  long = response[atc_dict[e.target.getPopup()._content]['index']]['atcFacilities'][0]['longitude']
                } else{
                  var icao = response[atc_dict[e.target.getPopup()._content]['index']]['airportIcao']
                  lat = AIRPORT_LOCATION_DATA[icao]['coordinates'].split(',')[0]
                  long = AIRPORT_LOCATION_DATA[icao]['coordinates'].split(',')[1]
                }


                delayedCount = 0
                totalCount = 0
                totalStillatAirport = 0

                // Inbound traffic handler
                for (j=0; j< inbound.length; j++){
                  plane = inbound[j]
                  //totalCount += 1
                  try{
                    dist = getDistanceFromLatLonInKm(latlngs_dict[plane]['lat'], latlngs_dict[plane]['lng'], lat, long)
                    t = parseInt((dist / (latlngs_dict[plane]['speed'] * 1.852)) * 60 + latlngs_dict[plane]['alt']/3000)
                    if (latlngs_dict[plane]['alt'] > 15000){
                      t += latlngs_dict[plane]['alt']/2000
                    }

                    numberOfMlSeconds = date.getTime();
                    addMlSeconds = 60 * 1000 * (t);
                    newDateObj = new Date(numberOfMlSeconds + addMlSeconds);
                    timeFormatted = (newDateObj.getHours() < 10 ? "0" : "") + newDateObj.getHours() + ":" + (newDateObj.getMinutes() < 10 ? "0" : "") + newDateObj.getMinutes()

                    endAirport = inboundFlightsDict[plane]
                    startAirport = outboundFlightsDict[plane]
                    aLat = AIRPORT_LOCATION_DATA[endAirport]['coordinates'].split(',')[0]
                    aLong = AIRPORT_LOCATION_DATA[endAirport]['coordinates'].split(', ')[1]
                    speed = latlngs_dict[plane]['speed']
                    dist = getDistanceFromLatLonInKm(lat, long, aLat, aLong)
                    timeToFly = dist / (speed * 1.852)
                    numberOfMlSeconds = date.getTime();
                    progress = dist
                    addMlSeconds = 60 * 60 * 1000 * (timeToFly);
                    newDateObj4 = new Date(numberOfMlSeconds + addMlSeconds);
                    predictedArrival = (newDateObj4.getHours() < 10 ? "0" : "") + newDateObj4.getHours() + ":" + (newDateObj4.getMinutes() < 10 ? "0" : "") + newDateObj4.getMinutes()

                    if (newDateObj4 > newDateObj){
                      latlngs_dict[plane]['time'] = 'Delayed'
                    }



                    if (latlngs_dict[plane]['speed'] > 100){
                      try{
                        inboundList.push({'name' : latlngs_dict[plane]['username'], 'dist' : dist, 'time': latlngs_dict[plane]['time'], 'due' : t, 'format' : timeFormatted, 'flightid' : plane, 'municipality' : AIRPORT_LOCATION_DATA[startAirport]['municipality']})
                      }catch(err){
                        inboundList.push({'name' : latlngs_dict[plane]['username'], 'dist' : dist, 'time': latlngs_dict[plane]['time'], 'due' : t, 'format' : timeFormatted, 'flightid' : plane})
                      }
                    }
                  }catch(err){
                      console.log(err)
                  }
                }

                // Outbound traffic handler
                for (j=0; j < outbound.length; j++){
                  try{
                    plane = outbound[j]
                    totalCount += 1
                    if (latlngs_dict[plane]['speed'] < 100){
                      // Now check still at departure airport
                      dist = getDistanceFromLatLonInKm(latlngs_dict[plane]['lat'], latlngs_dict[plane]['lng'], lat, long)
                      if (dist < 10){
                        timeLeftMins = 20 - 0.5 * latlngs_dict[plane]['length']
                        totalStillatAirport += 1
                        if (timeLeftMins > 0){
                          numberOfMlSeconds = date.getTime();
                          addMlSeconds = 60 * 1000 * (timeLeftMins);
                          newDateObj = new Date(numberOfMlSeconds + addMlSeconds);
                          timeFormatted = (newDateObj.getHours() < 10 ? "0" : "") + newDateObj.getHours() + ":" + (newDateObj.getMinutes() < 10 ? "0" : "") + newDateObj.getMinutes()
                        } else {
                          delayedCount += 1
                          numberOfMlSeconds = date.getTime();
                          addMlSeconds = 60 * 1000 * (timeLeftMins);
                          newDateObj = new Date(numberOfMlSeconds + addMlSeconds);
                          timeFormatted = (newDateObj.getHours() < 10 ? "0" : "") + newDateObj.getHours() + ":" + (newDateObj.getMinutes() < 10 ? "0" : "") + newDateObj.getMinutes()
                        }

                        endAirport = inboundFlightsDict[plane]
                        if (latlngs_dict[plane]['time'] === 'On Time'){
                          outboundList.push({'name' : latlngs_dict[plane]['username'], 'dist' : dist, 'due': timeLeftMins, 'time' : timeFormatted, 'format' : timeFormatted, 'flightid' : plane, 'status' : 'Scheduled', 'municipality': AIRPORT_LOCATION_DATA[endAirport]['municipality']})
                        } else {
                          timeFormatted += '*'
                          outboundList.push({'name' : latlngs_dict[plane]['username'], 'dist' : dist, 'due': timeLeftMins, 'time' : timeFormatted, 'format' : timeFormatted, 'flightid' : plane, 'status' : latlngs_dict[plane]['time'], 'municipality': AIRPORT_LOCATION_DATA[endAirport]['municipality']})
                        }
                      }
                    }
                  } catch(err){
                    console.log(err, endAirport)
                  }
                }


                inboundList.sort(compare)
                outboundList.sort(compare)
                ratio = delayedCount / totalStillatAirport

                trafficText = '✅ Airport is quiet, no delays expected.'
                trafficColour = '#C1E1C1'
                if (totalStillatAirport >= 5){
                  if (ratio > 0.2){
                    trafficText = '⚠️ Airport is busy, possible delays.'
                    trafficColour = '#fdfd96'
                    if (ratio > 0.4){
                      trafficText = '❌ Airport is very busy, expect delays.'
                      trafficColour = '#ff6961'
                    }
                  }
                }

                document.getElementById("rcorners1").style.color = "#FFFFFF";
                document.getElementById("rcorners1").innerHTML = (atc_dict[e.target.getPopup()._content]["title"])
                document.getElementById("rcorners2").innerHTML = (atc_dict[e.target.getPopup()._content]["text"])
                document.getElementById("rcorners3").innerHTML = trafficText
                document.getElementById("rcorners3").style.background = trafficColour


                txt = "&nbsp Arrival Board - click on the airline for more info. <br> <hr>"
                for (j=0; j<Math.min(5, inboundList.length-1); j++){
                  if (inboundList[j]['time'] == 'On Time'){
                    dial = '#c1e1c1'
                  } else {
                    dial = '#ed944d'
                  }

                  link = 'https://ifhub.onrender.com/?flightid=' + inboundList[j]['flightid'] + '&serverid=' + serverurl
                  try{
                    txt = txt + "<div style='background-color:#e7e7e7'> <p style='color:"+dial+";float:left;'>&nbsp ⬤</p> <p style='float:right; margin-right: 5px; background-color: black;'>[Due " +inboundList[j]['format'] + "]<br>(" +inboundList[j]['time'] + ")</p> <br> <a style='margin-left: 5px; color:black;'> " +inboundList[j]['municipality'] + '</a>' + "<br><a style='color: grey; margin-left: 5px;' href='" + link + "'>" + latlngs_dict[inboundList[j]['flightid']]['airline'] + " // " + latlngs_dict[inboundList[j]['flightid']]['aircraft'] + "</a><hr></div>"
                  } catch(err){
                    console.log(err)
                  }
                }

                txt += "<br><br>&nbsp Departure Board - click on the airline for more info. <br> <hr>"

                for (j=0; j<Math.min(5, outboundList.length); j++){
                  // formatting
                  timeLeftMins = 20 - 0.5 * latlngs_dict[outboundList[j]['flightid']]['length']
                  if (outboundList[j]['status'] == 'Scheduled'){
                    dial = '#ABB0B8'
                    if (timeLeftMins > 10 && timeLeftMins < 16){
                      outboundList[j]['status'] = 'Boarding'
                      dial = '#c1e1c1'
                    } else {
                        outboundList[j]['status'] = 'Gate closed'
                        dial = '#c1e1c1'
                    }
                  } else {
                    dial = '#ed944d'
                  }

                  link = 'https://ifhub.onrender.com/?flightid=' + outboundList[j]['flightid'] + '&serverid=' + serverurl
                  try{
                    txt = txt +"<div style='background-color:#e7e7e7'> <p style='color:"+dial+";float:left;'>&nbsp ⬤</p> <p style='float:right; margin-right: 5px; background-color: black;'>[Departs " +outboundList[j]['format'] + "]<br>(" +outboundList[j]['status'] + ")</p> <br> <a style='margin-left: 5px; color:black;'> " +outboundList[j]['municipality'] + '</a>' + "<br><a style='color: grey; margin-left: 5px;' href='" + link + "'>" + latlngs_dict[outboundList[j]['flightid']]['airline'] + " // " + latlngs_dict[outboundList[j]['flightid']]['aircraft'] + "</a><hr></div>"

                  } catch(err){
                    console.log(err)
                  }
                }



                document.getElementById("rcorners4").innerHTML = txt
                TYPE = 'airport'
                map.removeLayer(flightpath);
                openNav()
              })).on('popupclose', function(d) {
                closeNav()
              })
              marker.bindPopup(icao)
              if (hasActiveATC.includes(icao)){
                atcGroup.addLayer(marker)
              } else {
                nonAtcGroup.addLayer(marker)
              }
              if (map.getZoom() < 7){
                map.removeLayer(nonAtcGroup)
              }
              airport_markers[name] = marker
              ttl = ''
              try{
                ttl = 'Airport : ' + AIRPORT_LOCATION_DATA[icao]['iata_code'] + " ("+icao + ")<br><p style='font-size:10px'>" + AIRPORT_LOCATION_DATA[icao]['name'] + "</p>"
              } catch(err){
                ttl = 'Airport : ' + name
              }
              atc_dict[icao]= {title : ttl, text : 'Active Frequencies : <br><br>' + active_atc[name],
                                 index: i}
                //atc_dict[marker.getPopup()] = [{image : ""}, {text: }]
              }
              //map.addLayer(atcGroup)
          }
          //controlSearch.setLayer(atcGroup)
          if (ifclick == 'yes' && TO_UPDATE == 'yes'){
            if (TYPE == 'airport'){
              id = CURRENT_TRACK
              at = airport_markers[id]
              //map.flyTo([at._latlng['lat'], at._latlng['lng']], map.getZoom())
              at.fire('click')
              TO_UPDATE = 'no'
              UPDATING = 'no'
              }
            }
          }
        }


      function flight(serverurl, po) {
          //PRELOAD
        name_flightid = {}
        plane_markers = {}
        delayedForSearch = {}
        var server = serverurl
        var response = "";
        xhr4 = new XMLHttpRequest();

          // LOADING THE MAP & MAP ICONS

          map.setView((map.getCenter()), map.getZoom())


          // NETWORK/API

          xhr4.open('GET', "https://ifhubapi.onrender.com/flights?apikey=ZNvNHJYC5IcLYUMlFpBI&sessionid=" + serverurl, true);
          xhr4.send();
          xhr4.addEventListener("readystatechange", processRequest, false);

          function processRequest(e) {
            copylatlngs_dict = {}
            if (xhr4.readyState == 4 && xhr4.status == 200) {
              response = JSON.parse(xhr4.responseText);
              if (response.length == 0){
                flight(server)
                pause = setTimeout(airport(serverurl), 5000)
              }
              else{
                plane_markers = {}
                flight_dict = {}
                map.removeLayer(markerGroup)
                markerGroup = L.layerGroup().addTo(map);
                for (i = 0; i < response.length; i++) {
                  //DATA COLLECTION FROM THE API
                  var lat = response[i].latitude
                  var long = response[i].longitude
                  var direction = response[i].heading
                  var alt = response[i].altitude
                  var speed = response[i].speed
                  var vspeed = response[i].verticalSpeed
                  var username = response[i].username
                  var flightid = response[i].flightId
                  var heading = response[i].track
                  var callsign = response[i].callsign
                  var length = response[i].length
                  var aircraftId = response[i].aircraftId
                  var liveryId = response[i].liveryId
                  delayedForSearch[callsign] = response[i].time
                  delayedForSearch[username] = response[i].time
                  if (username != null){
                    copylatlngs_dict[flightid] = {'lat': lat, 'lng': long, 'username' : username, 'alt': alt, 'speed': speed, 'time' : response[i].time, 'length' : length}
                  }else{
                    copylatlngs_dict[flightid] = {'lat': lat, 'lng': long, 'username' : callsign, 'alt': alt, 'speed': speed, 'time' : response[i].time, 'length' : length}
                  }
                  var planeurl = ""
                  var directorminus = 0                                    //For landing and takeoff icons (make sure they point correctly)
                  var distance = (speed/1.94384)*60  //Longer to stop the stopping!



                  if(distance > 500){
                    // first work out how far it has moved since the server request and our request
                    deltaTimeOfRequest = (Date.now()/1000 - response[0]['timeOfRequest'])
                    var p =   destinationPoint(lat, long, ((speed/1.94384)*deltaTimeOfRequest), heading)
                    var lat = p[0]
                    var long = p[1]
                    // now our simulated distance
                    var p = destinationPoint(lat, long, distance, heading);
                    var predictionlat = p[0]
                    var predictionlong = p[1]
                  }else{
                    var predictionlat = lat
                    var predictionlong = long
                  }

                           //Air
                  if (username === "WML" || username === "Lewis"){
                    planeurl = "./resources/specialplaneicon.png"
                  }else{
                    planeurl = "./resources/planeicon.png"
                  }

                  directorminus = 0;

                  var planeIcon = L.icon({
                      iconUrl: planeurl,
                      iconSize: [20, 20], // size of the icon
                      });

                  customMarker = L.Marker.extend({
                      planeIcon : planeIcon})

                  name_flightid[response[i].username] = flightid
                  name_flightid[response[i].callsign] = flightid
                  popupName = response[i].username
                  if (popupName == null){
                    popupName = response[i].callsign
                  }

                  marker =  new L.Marker.movingMarker([[lat, long], [predictionlat, predictionlong]],[60000], {icon : planeIcon, rotationOrigin : 'center', rotationAngle : direction, title:popupName}).on('click', L.bind(markerOnClick, null, flightid, lat, long, speed, marker, e)).on('popupclose', function(e) {
                    map.removeLayer(flightpath);
                    closeNav()
                  }).addTo(markerGroup)
                  .bindPopup(popupName, {autoPan: false})
                  .on('click', dropdown)

                  plane_markers[flightid] = marker
                  marker.start()

                  if(popupName == response[i].callsign){
                    callsign = 'Guest'
                  } else{
                    callsign = response[i].callsign
                  }

                  if(response[i].virtualOrganization == null || response[i].virtualOrganization == ''){
                    organisation_message = 'This user is not a member of a Virtual Organisation'
                  } else{
                    organisation_message = 'Member of ' + response[i].virtualOrganization
                  }

                  counter = 0
                  for (j=0; j < LIVERY_DATA[aircraftId].length; j++){
                    if (LIVERY_DATA[aircraftId][j]['LiveryId'] === liveryId){
                      counter = j
                    }
                  }
                  copylatlngs_dict[flightid]['airline'] = LIVERY_DATA[aircraftId][counter]['LiveryName']
                  if (LIVERY_DATA[aircraftId][counter]['AircraftName'].split(' ').length > 1){
                    copylatlngs_dict[flightid]['aircraft'] = LIVERY_DATA[aircraftId][counter]['AircraftName'].split(' ')[1]
                  }else{
                    copylatlngs_dict[flightid]['aircraft'] = LIVERY_DATA[aircraftId][counter]['AircraftName']
                  }

                  flight_dict[popupName] = {head:popupName+ ' ('+ callsign +")<br><p style='font-size:10px'>" + LIVERY_DATA[aircraftId][counter]['AircraftName'] + ' - ' + LIVERY_DATA[aircraftId][counter]['LiveryName'] +'</p>', text:"Speed : " + parseInt(speed) + " &nbsp knots" + "<br><br>" + "Altitude : " + parseInt(alt) + "&nbsp FT ("+parseInt(vspeed)+" fpm)<br><br>Heading : " + parseInt(heading) + "°", foot:organisation_message, fid:flightid}

                  function dropdown(e){
                    //e.target.closePopup() controversial, maybe only for larger screens?
                    ifclick == 'yes'
                    TYPE = 'plane'
                    CURRENT_TRACK = flight_dict[e.target.getPopup()._content]["fid"]
                    document.getElementById("rcorners1").style.color = "#FFFFFF";
                    document.getElementById("rcorners1").style.background = "#000000";
                    document.getElementById("rcorners1").innerHTML = (flight_dict[e.target.getPopup()._content]["head"])
                    document.getElementById("rcorners2").innerHTML = (flight_dict[e.target.getPopup()._content]["text"])
                    document.getElementById("rcorners3").innerHTML = 'Please ensure flight plan is correctly filed for route information.'
                    document.getElementById("rcorners4").innerHTML = (flight_dict[e.target.getPopup()._content]["foot"])
                    openNav()
                  }

                  markerGroup.addTo(map)


                  function markerOnClick(flightid, lat, long, speed, marker, e) {
                    ifclick = "yes"
                    dataForGraph = []
                    dataForGraphSpeed = []
                    labels = []
                    var xhr = new XMLHttpRequest()
                    xhr.open('GET', "https://ifhubapi.onrender.com/flightDetails?apikey=ZNvNHJYC5IcLYUMlFpBI&flightid=" + flightid, true);
                    xhr.send();
                    xhr.addEventListener("readystatechange", processRequest, false);
                    function processRequest(e) {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        var latlonglist = []
                        response = JSON.parse(xhr.responseText);
                        map.removeLayer(flightpath)
                        flightpath = L.layerGroup().addTo(map)
                        var aLat = ''
                        var aLong = ''
                        try{
                          endAirport = inboundFlightsDict[flightid]
                          aLat = AIRPORT_LOCATION_DATA[endAirport]['coordinates'].split(',')[0]
                          aLong = AIRPORT_LOCATION_DATA[endAirport]['coordinates'].split(', ')[1]
                          dist = getDistanceFromLatLonInKm(lat, long, aLat, aLong)
                          // ^ before in case start not defined.
                          startAirport = outboundFlightsDict[flightid]
                          oLat = AIRPORT_LOCATION_DATA[startAirport]['coordinates'].split(',')[0]
                          oLong = AIRPORT_LOCATION_DATA[startAirport]['coordinates'].split(', ')[1]

                          delayedCheck = false
                          now = new Date()
                          // Predicted arrival

                          timeToFly = dist / (speed * 1.852)
                          numberOfMlSeconds = now.getTime();
                          progress = dist
                          addMlSeconds = 60 * 60 * 1000 * (timeToFly);
                          newDateObj4 = new Date(numberOfMlSeconds + addMlSeconds);
                          predictedArrival = (newDateObj4.getHours() < 10 ? "0" : "") + newDateObj4.getHours() + ":" + (newDateObj4.getMinutes() < 10 ? "0" : "") + newDateObj4.getMinutes()
                          if (speed < 100){
                            predictedArrival = 'Pending'
                          }

                          // Scheduled arrival

                          spawnTime = response[0]['Timings'][0]*1000

                          timePassed = (now.getTime() - spawnTime)/(60*1000)

                          dist = getDistanceFromLatLonInKm(oLat, oLong, aLat, aLong)
                          timeToFly = (dist / 890) + 0.75
                          //timePassed = response.length / 120
                          progress = Math.max(0,(1 - (progress / dist))*100)
                          t = timeToFly - timePassed
                          addMlSeconds = 60 * 60 * 1000 * (t);
                          newDateObj3 = new Date(spawnTime + 20*60*1000 + timeToFly*3600*1000);
                          scheduledArrival = (newDateObj3.getHours() < 10 ? "0" : "") + newDateObj3.getHours() + ":" + (newDateObj3.getMinutes() < 10 ? "0" : "") + newDateObj3.getMinutes()

                          // Scheduled Departure

                          if (timePassed > 0.3){
                            delta_t = 0.36 - timePassed
                          } else{
                            delta_t = (40-response.length)/120
                          }
                          addMlSeconds = 60 * 60 * 1000 * (delta_t);

                          newDateObj = new Date(spawnTime + 20*60*1000)
                          //newDateObj = new Date(numberOfMlSeconds + addMlSeconds);
                          scheduledDeparture = (newDateObj.getHours() < 10 ? "0" : "") + newDateObj.getHours() + ":" + (newDateObj.getMinutes() < 10 ? "0" : "") + newDateObj.getMinutes()


                          // Find actual departure

                          stamp = 0
                          for (i=response.length-1; i>=1; i--){
                            if (['Taking off' , 'Climbing'].includes(response[i].Status)){
                              if (response[i-1].Status === 'On the ground'){
                                stamp = i
                                break
                              }
                            }
                          }
                          if (response[0]['Timings'][1] != 0){
                            newDateObjTwo = new Date(response[0]['Timings'][1]*1000)
                            if (newDateObjTwo > newDateObj){
                              delayedCheck = true
                            }
                            actualDeparture = (newDateObjTwo.getHours() < 10 ? "0" : "") + newDateObjTwo.getHours() + ":" + (newDateObjTwo.getMinutes() < 10 ? "0" : "") + newDateObjTwo.getMinutes()
                          } else {
                            actualDeparture = 'Pending'
                          }

                          // Find actual arrival
/*
                          stamp = 0
                          if (response[0].BeenInAir == 'Yes'){
                            for (i=response.length-2; i>=0; i--){
                              if (['Landing' , 'Descending'].includes(response[i].Status)){
                                if (response[i+1].Status == 'On the ground'){
                                  if (getDistanceFromLatLonInKm(lat, long, aLat, aLong) < 10){
                                    stamp = i
                                    progress = 100
                                    break
                                  }
                                }
                              }
                            }
                          }
*/

                          if (response[0]['Timings'][2] > 0){
                            newDateObj = new Date(response[0]['Timings'][2]*1000)
                            actualArrival = (newDateObj.getHours() < 10 ? "0" : "") + newDateObj.getHours() + ":" + (newDateObj.getMinutes() < 10 ? "0" : "") + newDateObj.getMinutes()
                          } else{
                            actualArrival = 'Pending'
                          }

                          start_iata = AIRPORT_LOCATION_DATA[startAirport]['iata_code']
                          end_iata = AIRPORT_LOCATION_DATA[endAirport]['iata_code']
                          start_municipality = AIRPORT_LOCATION_DATA[startAirport]['municipality']
                          end_municipality = AIRPORT_LOCATION_DATA[endAirport]['municipality']

                          if (actualArrival == 'Pending'){
                            document.getElementById("rcorners3").innerHTML = "<span style='display:inline; float:left; line-height: 0.5em;'>&nbsp "+start_iata+" ["+scheduledDeparture+"]<br><p style='font-size: 10px;'>"+"</p><p style='font-size: 10px;'>Actual ("+actualDeparture+")</p></span> <span style='display:inline; float:right; line-height: 0.5em;'>"+end_iata+" ["+scheduledArrival+"] &nbsp<br><p style='font-size: 10px;'>Estimated ("+predictedArrival+")*</p></span> <spanstyle='display:inline; line-height: 0.5em;'>⮕</span>  <br> <br> <div class='wrapper'><div class='progress-bar'><span class='progress-bar-fill' style='width:"+progress+"%;'></span></div></div>"
                          }else{
                            document.getElementById("rcorners3").innerHTML = "<span style='display:inline; float:left; line-height: 0.5em;'>&nbsp "+start_iata+" ["+scheduledDeparture+"]<br><p style='font-size: 10px;'>Actual ("+actualDeparture+")</p></span> <span style='display:inline; float:right; line-height: 0.5em;'>"+end_iata+" ["+scheduledArrival+"] &nbsp<br><p style='font-size: 10px;'>Actual ("+actualArrival+")</p></span> <spanstyle='display:inline; line-height: 0.5em;'>⮕</span>  <br> <br> <div class='wrapper'><div class='progress-bar'><span class='progress-bar-fill' style='width:"+progress+"%;'>Arrived at destination</span></div></div>"
                          }

                          if (response[0]['Time'] == 'Delayed'){
                            document.getElementById("rcorners3").style.backgroundColor = '#ff6961'
                          }
                          if (['At cruise' , 'Descending', 'Landing'].includes(response[stamp].Status)){
                            if (newDateObj4 > newDateObj3){
                              delayedCheck = true
                            }else {
                              delayedCheck = false
                            }
                          }
                          if (delayedCheck == true){
                            document.getElementById("rcorners3").style.backgroundColor = '#ff6961'
                          } else {
                            document.getElementById("rcorners3").style.backgroundColor = '#C1E1C1'
                          }

                        } catch (err){
                          console.log(err)
                          }
                        //document.getElementById("rcorners3").innerHTML = 'Flying from ' + startAirport + ' to ' + endAirport + ' and will arrive at ' + predictedArrival + ' but is scheduled for ' + scheduledArrival + '. ' + response[0]['Time'] + '. Scheduled departure ' + scheduledDeparture + ', actual departure' + actualDeparture

                        for (i = 0; i < response.length; i++) {
                          if(response.length>50){
                            factor = parseInt(response.length/50)

                            if (i%factor==0){
                              dataForGraph.push(parseInt(response[i].Altitude))
                              dataForGraphSpeed.push(parseInt(response[i].Speed))
                              labels.push('')
                            }
                          } else{
                            dataForGraph.push(parseInt(response[i].Altitude))
                            dataForGraphSpeed.push(parseInt(response[i].Speed))
                            labels.push('')
                          }


                          var line_colour = ""
                          latlonglist.push(new L.LatLng(response[i].Latitude, response[i].Longitude))
                          if (response[i].Altitude < 500){
                            line_colour = "#ffffff"
                          }else if (response[i].Altitude < 1000){
                            line_colour = "#ccff99"
                          } else if (response[i].Altitude < 3000){
                            line_colour = "#66ff66"
                          } else if (response[i].Altitude < 8000) {
                              line_colour = "#66ff99"
                          } else if (response[i].Altitude < 10000) {
                            line_colour = "#66ffcc"
                          } else if (response[i].Altitude < 15000) {
                            line_colour = "#00ffff"
                          } else if (response[i].Altitude < 20000) {
                            line_colour = "#00ccff"
                          } else if (response[i].Altitude < 25000) {
                            line_colour = "#0066cc"
                          } else if (response[i].Altitude < 30000){
                            line_colour = "#003399"
                          } else{
                            line_colour = "#6600cc"
                          }
                          if (i > 0){
                             flightline = new L.Polyline([latlonglist[i-1], latlonglist[i]], {color : line_colour, smoothFactor : 100, weight : 3})
                             flightline.addTo(flightpath);
                           }
                       }

                       if (aLat != ''){
                         if (dist > 5){
                           currentplace = new L.LatLng(lat, long)
                           arrivalplace = new L.LatLng(aLat, aLong)
                           dashedpart = new L.Polyline([currentplace, arrivalplace], {color: 'black', dashArray : '5,5', weight: 2})
                           dashedpart.addTo(flightpath)
                         }
                       }

                       data = {
                          datasets: [{
                            label: 'Altitude',
                            borderColor: 'rgb(255,215,0)',
                            data: dataForGraph,
                            yAxisID: "y-axis-1"
                          },
                          {
                            label: 'Speed',
                            borderColor: 'rgb(52,140,235)',
                            data: dataForGraphSpeed,
                            yAxisID: "y-axis-2"
                          }],
                          labels: labels
                       }
                       document.getElementById('canvas').style.display='block'
                       myLineChart = new Chart(document.getElementById('canvas'), {
                            type: 'line',
                            data: data,
                            options: {scales: {
                                      yAxes: [{
                                          type: "linear", // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                                          display: true,
                                          position: "left",
                                          id: "y-axis-1",
                                          gridLines: {
                                            display: false
                                          }
                                      }, {
                                          type: "linear", // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                                          display: true,
                                          position: "right",
                                          id: "y-axis-2",
                                          gridLines: {
                                            display: false
                                          }}
                                        ],
                                      xAxes: [{
                                         gridLines: {
                                        display: false
                                      }
                                    }]}}});
                        document.getElementById('canvas').style.backgroundColor = 'rgb(255,255,255)';
                        flightpath.addTo(map)
                      }
                    }
                  }
                }
                controlSearch.setLayer(markerGroup)

                if (ifclick == 'yes' && TO_UPDATE == 'yes'){
                  if (TYPE == 'plane'){
                    fid = CURRENT_TRACK
                    plane = plane_markers[fid]
                    //map.flyTo([plane._latlngs[0]['lat'], plane._latlngs[0]['lng']], map.getZoom())
                    plane.fire('click')
                    TO_UPDATE = 'no'
                    UPDATING = 'no'
                  }
                }

                if (po == true){
                  queryString = window.location.search;
                  urlParams = new URLSearchParams(queryString);
                  if (urlParams.has('flightid')){
                    fid = urlParams.get('flightid')
                    if (fid in plane_markers){
                      plane = plane_markers[fid]
                      map.flyTo([plane._latlngs[0]['lat'], plane._latlngs[0]['lng']], 10)
                      plane.fire('click')
                      iflick = 'yes'
                    } else{
                      alert('This flight has ended.')
                    }
                  }
                }
              }
            latlngs_dict = copylatlngs_dict
            }
          }
        }

      queryString = window.location.search;
      urlParams = new URLSearchParams(queryString);
      if (urlParams.has('serverid')){
        serverurl = urlParams.get('serverid')
      }
      flight(serverurl, true)
      pause = setTimeout(airport(serverurl), 5000)


      var maplat;
      var maplong;

      var loop = setInterval(refresh, 30000);       // divide by 1000 for seconds (change later)  30 secs
      function refresh(){
        if(strikes < 5){
          data = map.getCenter()
          lat = data["lat"]
          long = data["lng"]
          if ( lat == check_lat && long == check_long){
            strikes += 1
          }
          else{
            strikes = 0
          }

          data = map.getCenter()
          zoom = map.getZoom()
          check_lat = data["lat"]
          check_long = data["lng"]
          maplat = data["lat"]
          maplong = data["lng"]
          TO_UPDATE = 'yes'
          UPDATING = 'yes'
          flight(serverurl, false)
          airport(serverurl)
        } else{
          clearInterval(loop);
          map.remove()
          alert("Due to your inactivity, you've been disconnected from the IFHub Server. Please refresh the page.")
        }
      }
      </script>
    </div>
  </body>
</html>
